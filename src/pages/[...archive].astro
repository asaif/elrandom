---
import { defaultLocale, moreLocales } from '@/config'
import Layout from '@/layouts/Layout.astro'
import { getPostsByYear } from '@/utils/content'
import { getPostPath } from '@/i18n/path'
import { ui } from '@/i18n/ui'

export async function getStaticPaths() {
  type PathItem = {
    params: { archive: string }
    props: { lang: string }
  }

  const paths: PathItem[] = []

  // Default locale
  paths.push({
    params: { archive: 'archive/' },
    props: { lang: defaultLocale },
  })

  // More locales
  moreLocales.forEach((lang: string) => {
    paths.push({
      params: { archive: `${lang}/archive/` },
      props: { lang },
    })
  })

  return paths
}

const { lang } = Astro.props
const postsByYear = await getPostsByYear(lang)
const currentUI = ui[lang as keyof typeof ui] ?? {}

// Calculate total posts
const totalPosts = Array.from(postsByYear.values()).reduce((sum, posts) => sum + posts.length, 0)

// Format date function for MM-DD
function formatDate(date: Date): string {
  const month = String(date.getMonth() + 1).padStart(2, '0')
  const day = String(date.getDate()).padStart(2, '0')
  return `${month}-${day}`
}

// Get all years as array for easier indexing
const yearsArray = Array.from(postsByYear.entries())
---

<Layout>
  <!-- Decorative Line -->
  <div class="uno-decorative-line" />
  
  <!-- Page Header -->
  <div class="mb-8">
    <h1 class="text-6 font-bold c-primary mb-3 font-navbar lg:text-7">
      {currentUI.archive || 'Archive'}
    </h1>
    <p class="text-3.6 c-secondary leading-1.5em lg:text-4">
      {currentUI.archiveDescription || 'A chronological collection of all posts'}
    </p>
    
    <!-- Total Posts Count -->
    <div class="mt-4 text-3.2 c-secondary">
      <span class="font-medium">{totalPosts}</span> posts across <span class="font-medium">{postsByYear.size}</span> years
    </div>
  </div>

  <!-- Posts Archive with Timeline -->
  {postsByYear.size > 0 ? (
    <div class="mt-10.5">
      {yearsArray.map(([year, posts], yearIndex) => (
        <div class="relative">
          <!-- Year Timeline Item -->
          <div class="flex items-center h-12 mb-2">
            <!-- Year -->
            <div class="w-16 text-right pr-4">
              <h2 class="text-4.5 font-bold c-primary font-navbar">
                {year}
              </h2>
            </div>
            
            <!-- Timeline Column -->
            <div class="relative w-4 h-full flex items-center justify-center">
              <!-- Year Circle (no line through it) -->
              <div class="w-3 h-3 rounded-full border-2 border-accent bg-white relative z-10"></div>
              <!-- Line starts AFTER the circle and continues to next section -->
              {(posts.length > 0 || yearIndex < yearsArray.length - 1) && (
                <div class="absolute w-px timeline-line-year border-l border-dotted border-secondary/30 left-1/2 transform -translate-x-1/2"></div>
              )}
            </div>
            
            <!-- Year Info -->
            <div class="pl-4">
              <!-- Empty space to maintain layout -->
            </div>
          </div>
          
          <!-- Posts for this year -->
          {posts.map((post, postIndex) => {
            const slug = post.data.abbrlink || post.id
            const postPath = getPostPath(slug, lang)
            
            return (
              <div class="flex items-center h-10 mb-1 group">
                <!-- Date -->
                <div class="w-16 text-right pr-4">
                  <time 
                    class="text-3.2 c-secondary font-time"
                    datetime={post.data.published.toISOString()}
                  >
                    {formatDate(post.data.published)}
                  </time>
                </div>
                
                <!-- Timeline Column -->
                <div class="relative w-4 h-full flex items-center justify-center">
                  <!-- Line continues only to next post in same year -->
                  {postIndex < posts.length - 1 && (
                    <div class="absolute w-px timeline-line-post border-l border-dotted border-secondary/30 left-1/2 transform -translate-x-1/2"></div>
                  )}
                  <!-- Post Dot with white outline to create gap -->
                  <div class="w-1.5 h-1.5 rounded-full bg-primary outline outline-4 outline-white relative z-10"></div>
                </div>
                
                <!-- Post Content -->
                <div class="flex-1 pl-4">
                  <div class="flex items-center justify-between">
                    <a 
                      href={postPath}
                      class="text-decoration-none"
                    >
                      <h3 
                        class="cjk:tracking-0.02em text-3.8 leading-1.4em transition-colors hover:c-primary group-hover:c-primary"
                        transition:name={`post-${slug}${lang ? `-${lang}` : ''}`}
                        data-disable-theme-transition
                      >
                        {post.data.title}
                      </h3>
                    </a>
                    
                    <!-- Tags -->
                    {post.data.tags && post.data.tags.length > 0 && (
                      <div class="flex gap-1.5 flex-wrap ml-4">
                        {post.data.tags.slice(0, 3).map(postTag => (
                          <a
                            href={`/${lang === defaultLocale ? '' : lang + '/'}tags/${postTag}/`}
                            class="inline-block px-2 py-0.5 text-2.8 c-secondary/70 bg-secondary/8 border border-secondary/15 rounded hover:c-primary/80 hover:border-secondary/30 hover:bg-secondary/12 transition-all ease-out text-decoration-none"
                          >
                            #{postTag}
                          </a>
                        ))}
                        {post.data.tags.length > 3 && (
                          <span class="text-2.8 c-secondary/50 px-2 py-0.5">
                            +{post.data.tags.length - 3}
                          </span>
                        )}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            )
          })}
          
          <!-- Add spacing between years -->
          {yearIndex < yearsArray.length - 1 && (
            <div class="h-6"></div>
          )}
        </div>
      ))}
    </div>
  ) : (
    <!-- Empty State -->
    <div class="text-center py-16">
      <div class="text-8 mb-4">ðŸ“š</div>
      <h3 class="text-4.5 font-medium c-primary mb-3">No posts yet</h3>
      <p class="text-3.6 c-secondary max-w-md mx-auto">
        Your archive will appear here once you start publishing posts.
      </p>
    </div>
  )}
</Layout>

<style>
  .timeline-line-year {
    top: 50%;
    bottom: -5px;
  }
  
  .timeline-line-post {
    height: 104%;
  }
</style>