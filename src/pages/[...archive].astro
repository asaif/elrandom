---
import { defaultLocale, moreLocales } from '@/config'
import Layout from '@/layouts/Layout.astro'
import { getPostsByYear } from '@/utils/content'
import { getPostPath } from '@/i18n/path'

export async function getStaticPaths() {
  type PathItem = {
    params: { archive: string }
    props: { lang: string }
  }

  const paths: PathItem[] = []

  // Default locale
  paths.push({
    params: { archive: 'archive/' },
    props: { lang: defaultLocale },
  })

  // More locales
  moreLocales.forEach((lang: string) => {
    paths.push({
      params: { archive: `${lang}/archive/` },
      props: { lang },
    })
  })

  return paths
}

const { lang } = Astro.props
const postsByYear = await getPostsByYear(lang)

// Format date function for MM-DD
function formatDate(date: Date): string {
  const month = String(date.getMonth() + 1).padStart(2, '0')
  const day = String(date.getDate()).padStart(2, '0')
  return `${month}-${day}`
}

// Convert Map to array for easier iteration
const yearsArray = Array.from(postsByYear.entries())
const totalPosts = yearsArray.reduce((sum, [_, posts]) => sum + posts.length, 0)
---

<Layout>
  <!-- Archive Posts with Timeline -->
  {totalPosts > 0 ? (
    <div class="archive-timeline">
      {yearsArray.map(([year, posts], yearIndex) => (
        <div class="year-section">
          <!-- Year Header -->
          <div class="flex items-center h-12 mb-4">
            <!-- Date Column -->
            <div class="w-16 text-right pr-4">
              <!-- Empty space to align with post dates -->
            </div>
            
            <!-- Timeline Column -->
            <div class="relative w-4 h-full flex items-center justify-center">
              <!-- Year line extends down to connect to posts -->
              {posts.length > 0 && (
                <div class="absolute w-px timeline-line-year border-l border-dotted border-secondary/30 left-1/2 transform -translate-x-1/2"></div>
              )}
              <!-- Year Dot -->
              <div class="w-2.5 h-2.5 rounded-full bg-primary outline outline-6 outline-white relative z-10"></div>
            </div>
            
            <!-- Year Label -->
            <div class="pl-4">
              <h2 class="text-4.5 font-semibold c-primary">
                {year}
              </h2>
            </div>
          </div>
          
          <!-- Posts for this year -->
          {posts.map((post, postIndex) => {
            const slug = post.data.abbrlink || post.id
            const postPath = getPostPath(slug, lang)
            
            return (
              <div class="post-entry group mb-6 lg:mb-4">
                <!-- Main post row -->
                <div class="flex items-start lg:items-center lg:h-10 mb-2 lg:mb-1">
                  <!-- Date -->
                  <div class="w-16 text-right pr-4 flex-shrink-0">
                    <time 
                      class="text-3.2 c-secondary font-time"
                      datetime={post.data.published.toISOString()}
                    >
                      {formatDate(post.data.published)}
                    </time>
                  </div>
                  
                  <!-- Timeline Column -->
                  <div class="relative w-4 flex-shrink-0 flex items-start lg:items-center justify-center" style="min-height: 1.5rem;">
                    <!-- Line continues only to next post in same year -->
                    {postIndex < posts.length - 1 && (
                      <div class="absolute w-px timeline-line-post border-l border-dotted border-secondary/30 left-1/2 transform -translate-x-1/2"></div>
                    )}
                    <!-- Post Dot with white outline to create gap -->
                    <div class="w-1.5 h-1.5 rounded-full bg-primary outline outline-4 outline-white relative z-10 mt-1 lg:mt-0"></div>
                  </div>
                  
                  <!-- Post Title -->
                  <div class="flex-1 pl-4">
                    <a 
                      href={postPath}
                      class="text-decoration-none"
                    >
                      <h3 
                        class="cjk:tracking-0.02em text-3.8 leading-1.4em transition-colors hover:c-primary group-hover:c-primary"
                        transition:name={`post-${slug}${lang ? `-${lang}` : ''}`}
                        data-disable-theme-transition
                      >
                        {post.data.title}
                      </h3>
                    </a>
                  </div>
                </div>
                
                <!-- Tags row (beneath title) -->
                {post.data.tags && post.data.tags.length > 0 && (
                  <div class="flex">
                    <!-- Empty space for date and timeline columns -->
                    <div class="w-16 flex-shrink-0"></div>
                    <div class="w-4 flex-shrink-0"></div>
                    
                    <!-- Tags container -->
                    <div class="flex-1 pl-4">
                      <div class="flex gap-1.5 flex-wrap">
                        {post.data.tags.slice(0, 4).map(postTag => (
                          <a
                            href={`/${lang === defaultLocale ? '' : lang + '/'}tags/${postTag}/`}
                            class="inline-block px-2 py-0.5 text-2.8 c-secondary/70 bg-secondary/8 border border-secondary/15 rounded hover:c-primary/80 hover:border-secondary/30 hover:bg-secondary/12 transition-all ease-out text-decoration-none"
                          >
                            #{postTag}
                          </a>
                        ))}
                        {post.data.tags.length > 4 && (
                          <span class="text-2.8 c-secondary/50 px-2 py-0.5">
                            +{post.data.tags.length - 4}
                          </span>
                        )}
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )
          })}
          
          <!-- Add spacing between years -->
          {yearIndex < yearsArray.length - 1 && (
            <div class="h-6"></div>
          )}
        </div>
      ))}
    </div>
  ) : (
    <!-- Empty State -->
    <div class="text-center py-16">
      <div class="text-8 mb-4">ðŸ“š</div>
      <h3 class="text-4.5 font-medium c-primary mb-3">No posts yet</h3>
      <p class="text-3.6 c-secondary max-w-md mx-auto">
        Your archive will appear here once you start publishing posts.
      </p>
    </div>
  )}
</Layout>

<style>
  .timeline-line-year {
    top: 50%;
    bottom: -5px;
  }
  
  .timeline-line-post {
    height: 104%;
  }
  
  /* Mobile-specific adjustments */
  @media (max-width: 1023px) {
    .post-entry {
      margin-bottom: 1.5rem;
    }
    
    .timeline-line-post {
      height: calc(100% + 1rem);
    }
    
    /* Better mobile tag spacing */
    .post-entry .flex-wrap {
      gap: 0.5rem;
    }
    
    /* Smaller tags on mobile */
    .post-entry a[class*="text-2.8"] {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
    }
  }
  
  /* RTL support for archive layout */
  :lang(ar) .post-entry {
    direction: rtl;
  }
  
  :lang(ar) .w-16 {
    text-align: left;
    padding-left: 1rem;
    padding-right: 0;
  }
  
  :lang(ar) .pl-4 {
    padding-right: 1rem;
    padding-left: 0;
  }
</style>