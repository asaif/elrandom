---
import TagList from '@/components/TagList.astro'
import { defaultLocale, moreLocales } from '@/config'
import Layout from '@/layouts/Layout.astro'
import { getAllTags, getPostsByTag, getTagSupportedLangs } from '@/utils/content'
import { getPostPath, getTagPath } from '@/i18n/path'

export async function getStaticPaths() {
  type PathItem = {
    params: { tags_tag: string }
    props: { tag: string, lang: string }
  }

  const paths: PathItem[] = []

  // Default locale
  const defaultTags = await getAllTags(defaultLocale)
  defaultTags.forEach((tag: string) => {
    paths.push({
      params: { tags_tag: `tags/${tag}/` },
      props: { tag, lang: defaultLocale },
    })
  })

  // More locales
  for (const lang of moreLocales) {
    const langTags = await getAllTags(lang)
    langTags.forEach((tag: string) => {
      paths.push({
        params: { tags_tag: `${lang}/tags/${tag}/` },
        props: { tag, lang },
      })
    })
  }

  return paths
}

const { tag, lang } = Astro.props
const posts = await getPostsByTag(tag, lang)
const allTags = await getAllTags(lang)
const supportedLangs = await getTagSupportedLangs(tag)

// Group posts by year
const postsByYear = new Map<number, typeof posts>()
posts.forEach(post => {
  const year = post.data.published.getFullYear()
  if (!postsByYear.has(year)) {
    postsByYear.set(year, [])
  }
  postsByYear.get(year)!.push(post)
})

// Sort years in descending order and sort posts within each year
const sortedYears = Array.from(postsByYear.keys()).sort((a, b) => b - a)
sortedYears.forEach(year => {
  postsByYear.get(year)!.sort((a, b) => b.data.published.getTime() - a.data.published.getTime())
})

// Format date function for MM-DD
function formatDate(date: Date): string {
  const month = String(date.getMonth() + 1).padStart(2, '0')
  const day = String(date.getDate()).padStart(2, '0')
  return `${month}-${day}`
}
---

<Layout supportedLangs={supportedLangs}>
  <!-- Decorative Line -->
  <div class="uno-decorative-line" />
  
  <!-- Tag List -->
  <TagList
    tags={allTags}
    currentTag={tag}
    lang={lang}
  />

  <!-- Posts List Grouped by Year with Timeline -->
  {posts.length > 0 && (
    <div class="mt-10.5">
      {sortedYears.map((year, yearIndex) => (
        <div class="relative">
          <!-- Year Header with Circle -->
          <div class="flex items-center gap-4 mb-6">
            <div class="flex items-center gap-3">
              <h2 class="text-4.5 font-bold c-primary font-navbar min-w-16">
                {year}
              </h2>
              <div class="w-3 h-3 rounded-full bg-accent flex-shrink-0"></div>
            </div>
          </div>
          
          <!-- Vertical Line -->
          {postsByYear.get(year)!.length > 0 && (
            <div class="absolute left-[4.25rem] top-12 w-px bg-secondary/20 h-[calc(100%-3rem)]"></div>
          )}
          
          <!-- Posts for this year -->
          <div class="space-y-4 pb-8">
            {postsByYear.get(year)!.map((post, postIndex) => {
              const slug = post.data.abbrlink || post.id
              const postPath = getPostPath(slug, lang)
              
              return (
                <div class="relative flex items-center gap-4">
                  <!-- Date -->
                  <div class="w-16 text-right">
                    <time 
                      class="text-3.2 c-secondary font-time"
                      datetime={post.data.published.toISOString()}
                    >
                      {formatDate(post.data.published)}
                    </time>
                  </div>
                  
                  <!-- Dot -->
                  <div class="w-2 h-2 rounded-full bg-primary flex-shrink-0 relative z-10"></div>
                  
                  <!-- Post Content -->
                  <div class="flex-1 flex items-center justify-between">
                    <a 
                      href={postPath}
                      class="text-decoration-none"
                    >
                      <h3 
                        class="cjk:tracking-0.02em text-3.8 leading-1.4em transition-colors hover:c-primary"
                        transition:name={`post-${slug}${lang ? `-${lang}` : ''}`}
                        data-disable-theme-transition
                      >
                        {post.data.title}
                      </h3>
                    </a>
                    
                    <!-- Tags -->
                    {post.data.tags && post.data.tags.length > 0 && (
                      <div class="flex gap-1.5 flex-wrap">
                        {post.data.tags.map(postTag => (
                          <a
                            href={getTagPath(postTag, lang)}
                            class="inline-block px-2 py-0.5 text-2.8 c-secondary/70 bg-secondary/8 border border-secondary/15 rounded hover:c-primary/80 hover:border-secondary/30 hover:bg-secondary/12 transition-all ease-out text-decoration-none"
                          >
                            {postTag}
                          </a>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              )
            })}
          </div>
        </div>
      ))}
    </div>
  )}

  <!-- Empty State -->
  {posts.length === 0 && (
    <div class="mt-10.5 text-center py-8">
      <p class="text-3.6 c-secondary">No posts found with this tag.</p>
    </div>
  )}
</Layout>