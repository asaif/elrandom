---
import TagList from '@/components/TagList.astro'
import { defaultLocale, moreLocales } from '@/config'
import Layout from '@/layouts/Layout.astro'
import { getAllTags, getPostsByTag, getTagSupportedLangs } from '@/utils/content'
import { getPostPath, getTagPath } from '@/i18n/path'

export async function getStaticPaths() {
  type PathItem = {
    params: { tags_tag: string }
    props: { tag: string, lang: string }
  }

  const paths: PathItem[] = []

  // Default locale
  const defaultTags = await getAllTags(defaultLocale)
  defaultTags.forEach((tag: string) => {
    paths.push({
      params: { tags_tag: `tags/${tag}/` },
      props: { tag, lang: defaultLocale },
    })
  })

  // More locales
  for (const lang of moreLocales) {
    const langTags = await getAllTags(lang)
    langTags.forEach((tag: string) => {
      paths.push({
        params: { tags_tag: `${lang}/tags/${tag}/` },
        props: { tag, lang },
      })
    })
  }

  return paths
}

const { tag, lang } = Astro.props
const posts = await getPostsByTag(tag, lang)
const allTags = await getAllTags(lang)
const supportedLangs = await getTagSupportedLangs(tag)

// Group posts by year
const postsByYear = new Map<number, typeof posts>()
posts.forEach(post => {
  const year = post.data.published.getFullYear()
  if (!postsByYear.has(year)) {
    postsByYear.set(year, [])
  }
  postsByYear.get(year)!.push(post)
})

// Sort years in descending order and sort posts within each year
const sortedYears = Array.from(postsByYear.keys()).sort((a, b) => b - a)
sortedYears.forEach(year => {
  postsByYear.get(year)!.sort((a, b) => b.data.published.getTime() - a.data.published.getTime())
})

// Format date function for MM-DD
function formatDate(date: Date): string {
  const month = String(date.getMonth() + 1).padStart(2, '0')
  const day = String(date.getDate()).padStart(2, '0')
  return `${month}-${day}`
}

// Get all years as array for easier indexing
const yearsArray = sortedYears.map(year => [year, postsByYear.get(year)!] as const)
---

<Layout supportedLangs={supportedLangs}>
  <!-- Decorative Line -->
  <div class="uno-decorative-line" />
  
  <!-- Tag List -->
  <TagList
    tags={allTags}
    currentTag={tag}
    lang={lang}
  />

  <!-- Posts List Grouped by Year with Timeline -->
  {posts.length > 0 ? (
    <div class="tag-posts-timeline mt-10.5">
      {yearsArray.map(([year, posts], yearIndex) => (
        <div class="year-section">
          <!-- Year Header -->
          <div class="flex items-center h-12 mb-4">
            <!-- Date Column -->
            <div class="w-16 text-right pr-4">
              <!-- Empty space to align with post dates -->
            </div>
            
            <!-- Timeline Column -->
            <div class="relative w-4 h-full flex items-center justify-center">
              <!-- Year line extends down to connect to posts -->
              {posts.length > 0 && (
                <div class="absolute w-px timeline-line-year border-l border-dotted border-secondary/30 left-1/2 transform -translate-x-1/2"></div>
              )}
              <!-- Year Dot -->
              <div class="w-2.5 h-2.5 rounded-full bg-primary outline outline-6 outline-white relative z-10"></div>
            </div>
            
            <!-- Year Label -->
            <div class="pl-4">
              <h2 class="text-4.5 font-semibold c-primary">
                {year}
              </h2>
            </div>
          </div>
          
          <!-- Posts for this year -->
          {posts.map((post, postIndex) => {
            const slug = post.data.abbrlink || post.id
            const postPath = getPostPath(slug, lang)
            
            return (
              <div class="post-entry group mb-6 lg:mb-4">
                <!-- Main post row -->
                <div class="flex items-start lg:items-center lg:h-10 mb-2 lg:mb-1">
                  <!-- Date -->
                  <div class="w-16 text-right pr-4 flex-shrink-0">
                    <time 
                      class="text-3.2 c-secondary font-time"
                      datetime={post.data.published.toISOString()}
                    >
                      {formatDate(post.data.published)}
                    </time>
                  </div>
                  
                  <!-- Timeline Column -->
                  <div class="relative w-4 flex-shrink-0 flex items-start lg:items-center justify-center" style="min-height: 1.5rem;">
                    <!-- Line continues only to next post in same year -->
                    {postIndex < posts.length - 1 && (
                      <div class="absolute w-px timeline-line-post border-l border-dotted border-secondary/30 left-1/2 transform -translate-x-1/2"></div>
                    )}
                    <!-- Post Dot with white outline to create gap -->
                    <div class="w-1.5 h-1.5 rounded-full bg-primary outline outline-4 outline-white relative z-10 mt-1 lg:mt-0"></div>
                  </div>
                  
                  <!-- Post Title -->
                  <div class="flex-1 pl-4">
                    <a 
                      href={postPath}
                      class="text-decoration-none"
                    >
                      <h3 
                        class="cjk:tracking-0.02em text-3.8 leading-1.4em transition-colors hover:c-primary group-hover:c-primary"
                        transition:name={`post-${slug}${lang ? `-${lang}` : ''}`}
                        data-disable-theme-transition
                      >
                        {post.data.title}
                      </h3>
                    </a>
                  </div>
                </div>
                
                <!-- Tags row (beneath title) -->
                {post.data.tags && post.data.tags.length > 0 && (
                  <div class="flex">
                    <!-- Empty space for date and timeline columns -->
                    <div class="w-16 flex-shrink-0"></div>
                    <div class="w-4 flex-shrink-0"></div>
                    
                    <!-- Tags container -->
                    <div class="flex-1 pl-4">
                      <div class="flex gap-1.5 flex-wrap">
                        {post.data.tags.map(postTag => (
                          <a
                            href={getTagPath(postTag, lang)}
                            class:list={[
                              "inline-block px-2 py-0.5 text-2.8 border border-secondary/15 rounded transition-all ease-out text-decoration-none",
                              postTag === tag 
                                ? "c-primary/90 bg-primary/10 border-primary/30 font-medium" 
                                : "c-secondary/70 bg-secondary/8 hover:c-primary/80 hover:border-secondary/30 hover:bg-secondary/12"
                            ]}
                          >
                            #{postTag}
                          </a>
                        ))}
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )
          })}
          
          <!-- Add spacing between years -->
          {yearIndex < yearsArray.length - 1 && (
            <div class="h-6"></div>
          )}
        </div>
      ))}
    </div>
  ) : (
    <!-- Empty State -->
    <div class="mt-10.5 text-center py-8">
      <p class="text-3.6 c-secondary">No posts found with this tag.</p>
    </div>
  )}
</Layout>

<style>
  .timeline-line-year {
    top: 50%;
    bottom: -5px;
  }
  
  .timeline-line-post {
    height: 104%;
  }
  
  /* Mobile-specific adjustments */
  @media (max-width: 1023px) {
    .post-entry {
      margin-bottom: 1.5rem;
    }
    
    .timeline-line-post {
      height: calc(100% + 1rem);
    }
    
    /* Better mobile tag spacing */
    .post-entry .flex-wrap {
      gap: 0.5rem;
    }
    
    /* Smaller tags on mobile */
    .post-entry a[class*="text-2.8"] {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
    }
    
    /* Current tag highlighting on mobile */
    .post-entry a[class*="c-primary/90"] {
      font-weight: 600;
    }
  }
  
  /* RTL support for tag pages */
  :lang(ar) .post-entry {
    direction: rtl;
  }
  
  :lang(ar) .w-16 {
    text-align: left;
    padding-left: 1rem;
    padding-right: 0;
  }
  
  :lang(ar) .pl-4 {
    padding-right: 1rem;
    padding-left: 0;
  }
  
  /* Better tag layout for smaller screens */
  @media (max-width: 768px) {
    .tag-posts-timeline {
      margin-top: 2rem;
    }
    
    /* Stack tags more compactly on very small screens */
    @media (max-width: 480px) {
      .post-entry .flex-wrap {
        gap: 0.375rem;
      }
      
      .post-entry a[class*="text-2.8"] {
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
      }
    }
  }
</style>